define(["jquery","modules/clean/ajax","modules/clean/analytics","modules/clean/base64","modules/clean/datetime","modules/clean/event_load","modules/clean/filepath","modules/clean/open_in_mobile_app","modules/clean/photos/legacy_thumb_loader","modules/clean/uuid","modules/clean/viewer","modules/constants/mobile","modules/core/browser","modules/core/cookies","modules/core/exception","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,r,o,a,s,l,d,u,c,h,f,p,m,_,g,v){var w={},b=l.LegacyBatchThumbLoader,x=(u.Viewer,f.Cookies),assert=p.assert,y=(m.HTML,_._),k=(g.Notify,v.URI),E=e,C=function(){return navigator.userAgent.search("iPhone")>-1},T=function(){return navigator.userAgent.search("Windows Phone OS")>-1},O=function(){return E(".page").attr("id")},I=function(){var e,t=O();if(t){if("share"===t)return e=E("#share div.ui-content a").width(),S(e);if("home"===t||"search"===t)return e=E(window).width(),A(e);if("login"===t||"register"===t){var n=E("#register-page").css("display");return e=n&&"none"!==n?E("#register-page .ui-input-text").width():E(".ui-input-text").width(),R(e)}}},S=function(e){return E("#share div.ui-content input").css({width:e-13})},A=function(e){return E("div.search-bar div.ui-block-a").css({width:e-41-5}),E("div.search-bar div.ui-input-search").css({width:e-41-10-30-5})},R=function(e){return E("form input.ui-input-text").css({width:e-8})},j=E(window).width(),L=function(){return T()?setInterval(function(){if(E(window).width()!==j)return j=E(window).width(),I()},1e3):E(window).on("orientationchange",function(){return setTimeout(I,200)})},D=function(){I();var e=O();"register"===e?E("#register form #tos_checkbox").prop("checked")&&E("#tos_r .ui-checkbox .ui-icon").addClass("ui-icon-checkbox-active"):"login"===e&&(E("#login form #remember_me_checkbox").prop("checked")||(E("#remember_me_l .ui-checkbox .ui-icon").addClass("ui-icon-checkbox"),E("#remember_me_l .ui-checkbox .ui-icon").removeClass("ui-icon-checkbox-active")))},P=function(){return E("#mobile_locale_selector").on("change",function(){return U.postRequest("/set_locale",{locale:E(this).val(),locale_cont:h.get_href()})})};w.kill_notification=function(){return x.create(c.MOBILE_AD_COOKIE,i.encode("ptz"),c.MOBILE_AD_COOKIE_EXPIRES),E("#notification_box").toggle()},w.login_link=function(){return E("#login-page").show(),E("#register-page").hide(),E("#login_link_div").hide(),E("#sign-in-link").hide(),E("#create_account_link_div").show(),E("#register-link").show(),E("#header_txt").html(y("Sign in")),!1},w.create_account_link=function(){return E("#login-page").hide(),E("#register-page").show(),E("#login_link_div").show(),E("#sign-in-link").show(),E("#create_account_link_div").hide(),E("#register-link").hide(),E("#header_txt").html(y("Create account")),!1};String.prototype.snippet=function(e){if(null==e&&(e=50),this.length<=e)return this;e-="...".length;var t=Math.floor(.75*e),n=e-t,i=this.length-n;return this.substr(0,t)+"..."+this.substr(i,n)},E(D),L(),P();var M=(w.DomUtil={fillVal:function(t,n){return(function(){for(var i=[],r=0,o=Array.from(e("."+n));r<o.length;r++){var a=o[r];"INPUT"===a.tagName?(a.value=t,i.push(a.defaultValue=t)):i.push(a.innerHTML=t)}return i})()},fromElm:function(t){return assert(e(t),"No elements match this selector"),e(t)[0].innerHTML}},w.Util={keep_cont_params:function(t){if(window.location.search.indexOf("cont")!==-1){var n=e(t),i=n.attr("href");n.attr("href",""+i+window.location.search)}},urlquote:function(e){return e.split("/").map(encodeURIComponent).join("/")},unquote:function(e){return e.split("/").map(decodeURIComponent).join("/")},is_retina_display:window.devicePixelRatio>1,hashString:function(e){for(var t=0,n=0;n<e.length;)t=(t<<5)-t+e.charCodeAt(n),t&=t,n++;return t},preloaded_images:{},preload_image:function(t,n){if(!M.preloaded_images[t]){var i=new Image;return null!=n&&n&&e(i).error(n),i.src=t,M.preloaded_images[t]=i}},get_preloaded_image:function(t){return e(M.preloaded_images[t]?M.preloaded_images[t]:'<img src="'+t+'" />')},video_elm:function(t,n,i,r){var o=e("<video></video>").attr("src",t);return n&&e(o).attr("autoplay","true"),i&&e(o).attr("poster",i),r&&e(o).attr("controls","1"),o},get_preview_img_dimensions:function(t){var n={width:e("#file-preview-modal .preview").width()||e(window).width(),height:e("#file-preview-modal .preview").height()||e(window).height()},i={width:t.naturalWidth,height:t.naturalHeight},r=i.width/n.width,o=i.height/n.height,a=Math.max(r,o);return!(a<1)&&{width:Math.floor(i.width/a),height:Math.floor(i.height/a)}},track_twitter_chars_left:function(t,n){clearInterval(M.chars_left_interval);var i=function(){var i=e("#twitter-chars"),r=n-e("#"+t).val().trim().length;return r<0?i.addClass("too-long"):i.removeClass("too-long"),i.text(r)};return M.chars_left_interval=setInterval(i,250)},screen_width:null,set_screen_width:function(e){return M.screen_width===window.innerWidth?setTimeout(M.set_screen_width,1):(M.screen_width=window.innerWidth,e?e():void 0)},resize_inputs:function(){var t=window.innerWidth-30;return e("input[type=text], input[type=password], input[type=email], textarea").outerWidth(t)},_batch_thumb_endpoints:null,load_thumbs_in_view:function(t){var n,i,r,o,a,s,l=e(t);if(l.length){for(var d=e(window).scrollTop(),u=e(window).height(),c=l.first().offset().top,h=0;h<l.length;h++){var f=l[h];f=l[h],e(f).hasClass("thumb-loaded")||(e(f).offset().top>c&&(c=e(f).offset().top),c>d-u&&c<d?(null==i&&(i=h),a=h):c>d&&c<d+u?(null==r&&(r=h),s=h):c>d+u&&c<d+8*u&&(null==n&&(n=h),o=h))}return M._load_thumbs_from_indices(l,r,s,n,i,o,a)}},_load_thumbs_from_indices:function(t,n,i,r,o,a,s){for(var l=function(t){return e(t).parent().addClass("thumb-loaded")},d=[],u=[[n,i],[r,a],[o,s]],c=0,h=Array.from(u);c<h.length;c++)for(var f=h[c],p=f[0],m=f[1],_=f[0]<=m;_?p<=m:p>=m;_?p++:p--)d.push(e(t[p]).find("img")[0]);return b.batch_load_thumbs(d,15,l)},blackout_background:function(t,n){return e("body").addClass("blackout"),e(t).addClass("no-opacity"),e(n).addClass("no-opacity")},unblackout_background:function(t,n){return e("body").removeClass("blackout"),e(t).removeClass("no-opacity"),e(n).removeClass("no-opacity")},desktop_friendly_touchend:"ontouchend"in window?"touchend":"click",desktop_friendly_touchstart:"ontouchstart"in window?"touchstart":"click",hide_url_bar:function(){return setTimeout(function(){return window.scrollTo(0,1)},100)},smart_window_load:function(t){return"complete"===document.readyState?setTimeout(t,0):e(window).on("load",t)}}),N=w.TouchUtil={doubletap:function(t,n){var i=function(t){t=t.originalEvent;var i=function(){return this.touch=!1},r=e.proxy(i,this);if(1!==t.touches.length||1!==t.changedTouches.length)return void r();var o=t.changedTouches[0];if(this.touch){var a={x:Math.abs(o.clientX-this.touch.x),y:Math.abs(o.clientY-this.touch.y)};return a.x>25||a.y>25?void r():n()}return this.touch={x:o.pageX,y:o.pageY},setTimeout(r,250)};return e(t).bind("touchstart",i)},gesturestart:function(t,n){if(C())return e(t).bind("gesturestart",n);var i=function(e){if(e=e.originalEvent,e.touches.length>1||e.changedTouches.length>1)return n()};return e(t).bind("touchstart",i)}},U=w.Forms={submitOnlyOnce:function(){var e=U.submitted!==!0;return U.submitted=!0,e},add_vars:function(t,n){return t=e(t),(function(){for(var i=[],r=0,o=Object.keys(n||{});r<o.length;r++){var a=o[r],s=e("<input />").attr("type","hidden").attr("name",a).val(n[a]);i.push(t.append(s))}return i})()},parse_error:function(e,t){return e[t].message_text||e[t].message_html},collect_form_vars:function(t){t=E(t||E(document.body));for(var n=e.merge(t.find("input"),t.find("textarea"),t.find("select")),i={},r=0,o=Array.from(n);r<o.length;r++){var a=o[r];if(a.name&&"t"!==a.name){if("checkbox"===e(a).attr("type")&&!e(a).prop("checked"))continue;var s=e(a).val();s&&("string"!=typeof s&&(s=s.join(",")),null!=i[a.name]?"string"==typeof i[a.name]?i[a.name]=[i[a.name],s]:i[a.name].push(s):i[a.name]=s)}}return i},ajax_submit:function(n,i,r,o,a,s){if(n.ajax_submitted)return!1;n.ajax_submitted=!0;var l=U.collect_form_vars(n);return s&&e.extend(l,s),t.SilentBackgroundRequest({url:i||n.action,data:l,dataType:a||"text",success:function(e,t,n){return"function"==typeof r?r(n,e):void 0},error:function(e){if(e)if(0===e.responseText.indexOf("err:")){var t=e.responseText.substr(4);if(0===t.indexOf("{")){var i=JSON.parse(t);U.fill_errors(n,i)}else alert(t)}else alert("There was a problem completing this request");return"function"==typeof o?o(e):void 0},complete:function(e){return n.ajax_submitted=!1}}),!1},clear_errors:function(t){return t=t||e(document.body),t.find(".error-removable").remove()},fill_errors:function(t,n){return n=n||{},t=t||e(document.body),U.clear_errors(t),(function(){for(var i=[],r=0,o=Object.keys(n||{});r<o.length;r++){var a=o[r],s=t.find("[name="+a+"]")||t.find("[data-error-field-name="+a+"]");if(s){var l=e("<div></div>").attr("class","error-message error-removable");l.html(U.parse_error(n,a)),i.push(l.insertBefore(s))}else i.push(void 0)}return i})()},postRequest:function(t,n,i){void 0===n&&(n={}),void 0===i&&(i={}),assert(null!=t,"postRequest missing action"),n.t=x.read("__Host-js_csrf");var r=e('<form method="POST"></form>').attr("action",t);return i.target&&(r.target=i.target),e(document.body).append(r),U.add_vars(r,n),r.submit()}},z=w.BrowseFile={};z.CATEGORY_TO_TRANSLATION={FILE:y("file"),FOLDER:y("folder"),SHARED_FOLDER:y("shared folder"),PUBLIC_FOLDER:y("folder"),IMAGE:y("image"),VIDEO:y("video"),AUDIO:y("audio"),DOCUMENT:y("document"),COMPRESSED_FILE:y("archive"),CODE:y("code"),DISK_IMAGE:y("disk image"),EXECUTABLE:y("executable"),SHORTCUT:y("shortcut"),LINK:y("link"),FONT:y("font"),SANDBOX:y("app folder")},z._CATEGORIES={IMAGE:"bmp cr2 gif heic heif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts mxf ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 asm aspx bat c cc cmake coffee cpp cs css cxx diff erb erl groovy gry h haml hh hpp hxx java js json jsx less lst m make ml mm out patch php pl plist properties py rb sass scala scm script scss sh sml sql vb vi vim xml xsd xsl yaml yml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"},z.EXTENSION_TO_CATEGORY={};for(var q in z._CATEGORIES)for(var H=z._CATEGORIES[q],G=0,F=H.trim().split(" ");G<F.length;G++){var B=F[G];z.EXTENSION_TO_CATEGORY[B]=q}var V=this&&this.__extends||(function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}})(),X=(function(){var t=w.FilePreview=(function(){function t(){}return t.initClass=function(){this.prototype.fail_image_src="/static/images/preview_fail-vflc3IDxf.png"},t.prototype.preload=function(){},t.prototype.render=function(){},t.prototype.show_fail=function(t){var n=e("<div></div>").append(y("Unable to preview this item.",{comment:"preview means showing the item in the same browser window without downloading a copy"}));return t.append(n)},t})();return t.initClass(),t})(),W=w.PhotoPreview=(function(t){function n(e,n,i,r,o,a,s){var l=t.call(this)||this;return l.filename=e,l.fq_path=n,l.thumbnail_url_tmpl=i,l.dl_url=r,l.original_url=o,l.display_time=a,l.shmodel_link=s,l}return V(n,t),n.prototype.fallback=function(t){var n=e(t.target);return n.attr({src:this.fail_image_src,width:128,height:128}),this.show_fail(n.parents("div.content-item"))},n.prototype.preload=function(){var e=k.parse(this.thumbnail_url_tmpl).updateQuery({size:"2048x1536"}).toString();M.preload_image(e,this.fallback.bind(this));var t=M.get_preloaded_image(e);return t.attr("class","thumbnail"),t},n.prototype.render=function(){var t=this.preload(),n=e("<div/>").append(t),i=t.attr("src").length;return t.attr("src").substring(i-this.fail_image_src.length,i)===this.fail_image_src&&this.show_fail(n),n},n.prototype.get_elm=function(){return e("#file-preview-modal img.thumbnail")[0]},n.prototype.show_loading=function(){if(!e("#file-preview-modal .loading-image").length){return e("#file-preview-modal .preview-content").append(e("<img class='loading-image' src='/static/images/icons/ajax-loader-black-2x-vfl_cqC2b.gif'/>"))}},n.prototype.hide_loading=function(){return e("#file-preview-modal .loading-image").remove()},n.prototype.listen_for_click=function(){},n})(X),Y=(w.VideoPreview=(function(t){function n(e,n,i,r,o,a,s,l){var d=t.call(this)||this;return d.filename=e,d.fq_path=n,d.thumbnail_url_tmpl=i,d.dl_url=r,d.original_url=o,d.display_time=a,d.shmodel_link=s,d.preview_url=l,d}return V(n,t),n.prototype.fallback=function(t){var n=e(t.target);return n.attr({src:this.fail_image_src,width:128,height:128}),this.show_fail(n.parents("div.content-item"))},n.prototype.preload=function(){var e=k.parse(this.thumbnail_url_tmpl).updateQuery({size:"2048x1536"}).toString();M.preload_image(e,this.fallback.bind(this));var t=M.get_preloaded_image(e);return t.attr("class","thumbnail"),t},n.prototype.render=function(){var t=this.preload(),n=M.video_elm(this.preview_url,!1,t.attr("src")),i=e("<div></div>").append('<div class="play-button"><img src="/static/images/playbutton2-vflS-2IRk.png" /></div>').append(t).append(n),r=t.attr("src").length;return t.attr("src").substring(r-this.fail_image_src.length,r)===this.fail_image_src&&this.show_fail(i),i},n.prototype.get_elm=function(){return e("#file-preview-modal img.thumbnail")[0]},n.prototype.show_loading=function(){},n.prototype.hide_loading=function(){},n.prototype.listen_for_click=function(){var t=e(".content-item video")[0];return e(".play-button").bind(M.desktop_friendly_touchstart,function(e){return e.stopPropagation(),t.play()})},n})(X),w.Lightbox=(function(){var t=[],n=0,i=!1,r=void 0,o=void 0,a=void 0,s=function(t){return e(t).prop("complete")!==!1},l=function(){Y.resize_and_update_modal_position();var i=t[n].get_elm();if(i&&s(i)){var r=M.get_preview_img_dimensions(i);return i=e(i),i.css({visibility:""}),r?(i.css({width:r.width+"px"}),i.css({height:r.height+"px"})):(i.css({width:""}),i.css({height:""}))}},d=void 0,u=void 0,c=void 0,h=!1,f=C()?"fadeout-iphone":"fadeout",p=function(){if(h){var t=e("#file-preview-modal");return t.find(".lightbox-menu").addClass(f),t.find(".header").addClass(f),t.find(".prev").addClass(f),t.find(".next").addClass(f),t.find(".lightbox-exit").unbind(M.desktop_friendly_touchstart,I).unbind("touchend",S).unbind("touchend",T),t.unbind(M.desktop_friendly_touchend,p),t.bind(M.desktop_friendly_touchend,u),h=!1}},m=function(){if(d&&clearTimeout(d),!h){var t=e("#file-preview-modal");return t.find(".lightbox-menu").removeClass(f),t.find(".header").removeClass(f),t.find(".prev").removeClass(f),t.find(".next").removeClass(f),t.find(".lightbox-exit").bind(M.desktop_friendly_touchstart,I).bind("touchend",S).bind("touchend",T),t.bind(M.desktop_friendly_touchend,p),t.unbind(M.desktop_friendly_touchend,u),h=!0}};u=function(){return m(),c()},c=function(){return d=setTimeout(p,3112)};var _=function(e){var i=t.length;return(i+(n+e)%i)%i},g=function(e){return t[e].preload()},v=function(){var e=[1,-1,2,-2,3,-3,4,-4];return(function(){for(var n=[],i=0,r=Array.from(e);i<r.length;i++){var o=r[i];Math.abs(o)<t.length?n.push(g(_(o))):n.push(void 0)}return n})()},w=function(i){assert(n<t.length,"Invalid index "+n);var r=t[n],a=r.render();a.addClass("content-item");var d=e("#file-preview-modal"),h=d.find(".preview-content"),f=a.find("img.thumbnail");if(r instanceof W){var _=function(){return window.location.href=k.parse(r.thumbnail_url_tmpl).updateQuery({size:"1024x768"}).toString()};N.doubletap(f,_),N.gesturestart(f,_)}f.hide(),h.html(a),d.find(".current_index").text(n+1),d.find(".total").text(o.num_previews||t.length),r.display_time?r.filename.match(/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/)?d.find(".filename").text(r.display_time):d.find(".filename").text(r.filename.snippet(20)+" - "+r.display_time):d.find(".filename").text(r.filename.snippet(40)),d.find(".filename").attr("title",r.filename),1===t.length?(d.find(".prev").hide(),d.find(".next").hide()):0===n&&o.no_wrap?(d.find(".prev").hide(),d.find(".next").show()):n===t.length-1&&o.no_wrap?(d.find(".prev").show(),d.find(".next").hide()):(d.find(".prev").show(),d.find(".next").show());var g=!Y.shown;return s(f)?(g&&u(),l(),f.show(),r.listen_for_click()):(g&&m(),r.show_loading(),f.load(function(){return g&&c(),r.hide_loading(),l(),f.show(),r.listen_for_click()})),g||(i?u():p()),e(document).trigger(Y.PHOTO_CHANGE_EVT,r),history.replaceState({lightbox:!0},"","#f:"+M.urlquote(t[n].filename)),v()},b=function(i){var r=e("#file-preview-modal").find(".next");if(r.addClass("pressed"),i&&i.stopPropagation(),n!==t.length-1||!o.no_wrap)return setTimeout(function(){return n=_(1),w(0===n),r.removeClass("pressed")},3),!1},x=function(t){var i=e("#file-preview-modal").find(".prev");if(i.addClass("pressed"),t&&t.stopPropagation(),0!==n||!o.no_wrap)return setTimeout(function(){return n=_(-1),w(),i.removeClass("pressed")},3),!1},y=function(){return!1},T=void 0,O=function(){var t=e("#file-preview-modal");return t.find(".next").unbind(M.desktop_friendly_touchend,b),t.find(".prev").unbind(M.desktop_friendly_touchend,x),t.find(".lightbox-exit").unbind(M.desktop_friendly_touchstart,I).unbind("touchend",S).unbind("touchend",T),e(window).unbind("popstate",T),e(document).unbind("touchmove",y),clearInterval(r),i=!1},I=function(t){return e(t.target).parent().addClass("selected")},S=function(t){return e(t.target).parent().removeClass("selected")};a=function(){if(Y.shown){var t=e("#file-preview-modal");return t.hide(),t.find(".preview-content").empty(),e(document.body).removeClass("full-no-overflow"),p(),O(),Y.shown=0}};T=function(i){if(i.stopPropagation(),i.preventDefault(),!i||"popstate"!==i.originalEvent.type||i.originalEvent.state&&!i.originalEvent.state.lightbox)return M.unblackout_background(o.header_selector,o.content_selector),a(),history.replaceState({},"","#"),e(document).trigger("db:filepreview:exitselect",t[n]),!1};var A=function(){if(!i){var t=e("#file-preview-modal");t.find(".next").bind(M.desktop_friendly_touchend,b),t.find(".prev").bind(M.desktop_friendly_touchend,x),t.find(".lightbox-exit").bind(M.desktop_friendly_touchstart,I).bind("touchend",S).bind("touchend",T),e(window).bind("popstate",T),e(document).bind("touchmove",y),i=!0}return r=setInterval(l,500)},R=function(){var e=k.parse(window.location.href).fragment.substr(2);if(e){for(var i=0;i<t.length;i++){if(e===t[i].filename)return n=i,void(Y.shown||Y.show())}return history.replaceState({},"","#")}},j=function(){var e="/static/images/mobile/thebest/";return M.preload_image(e+"lightbox_exit.png"),M.preload_image(e+"lightbox_exit_pressed.png"),M.preload_image(e+"lightbox_right_arrow.png"),M.preload_image(e+"lightbox_right_arrow_pressed.png"),M.preload_image(e+"lightbox_left_arrow.png"),M.preload_image(e+"lightbox_left_arrow_pressed.png"),M.preload_image("/static/images/icons/ajax-loader-black-2x-vfl_cqC2b.gif"),M.preload_image("/static/images/playbutton2-vflS-2IRk.png"),M.preload_image("/static/images/preview_fail-vflc3IDxf.png")};return{get_file_previews:function(){return t},refresh:function(){if(Y.shown)return w()},init:function(e,n){if(!Y.shown)return j(),n=n||{},o={include_delete:n.include_delete||!1,num_previews:n.num_previews||null,header_selector:n.header_selector,content_selector:n.content_selector},t=e,void 0!==n.start_index?Y.show(n.start_index):R()},resize_and_update_modal_position:function(){var t="translateY("+window.pageYOffset+"px)";return"fixed"===E("#file-preview-modal").css("position")&&(t=""),e("#file-preview-modal").css({width:window.innerWidth,height:window.innerHeight,"-webkit-transform":t,transform:t,"-ms-transform":t,"-moz-transform":t,"-o-transform":t})},show:function(i){if(!Y.shown)return assert(t&&t.length,"Lightbox.show() requires file preview objects to show"),A(),void 0!==i&&(n=i),history.replaceState({},"","#"),history.pushState({lightbox:!0},"","#"),assert(!Y.shown,"Trying to reshow file preview modal"),e("#file-preview-modal").show(),M.blackout_background(o.header_selector,o.content_selector),e(document.body).addClass("full-no-overflow"),w(),Y.shown=1},set_no_wrap:function(e){return o.no_wrap=e},PHOTO_CHANGE_EVT:"db:lightbox:photo_change",EXIT_SELECT_EVT:"db:filepreview:exitselect",reload:!1}})());return w});
//# sourceMappingURL=mobile.min.js-vflu-Xtb2.map